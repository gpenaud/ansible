all:
  children:

    # --------------------- #
    # needys infrastructure #
    # --------------------- #

    # groups of hosts
    needys-api-need:
      hosts:
        apis.needys.lxc:
      vars:
        needys_api_need_binary_options:
        - --server.host 0.0.0.0
        - --server.port 8010
        - --rabbitmq.host services.needys.lxc
        - --rabbitmq.port 5672
        - --rabbitmq.username needys
        - --rabbitmq.password needys
        - --mysql.host services.needys.lxc
        - --mysql.port 3306

    needys-output-producer:
      hosts:
        apis.needys.lxc:
      vars:
        needys_output_producer_binary_options:
        - --rabbitmq.host services.needys.lxc
        - --rabbitmq.port 5672
        - --rabbitmq.username needys
        - --rabbitmq.password needys

    needys-services:
      hosts:
        services.needys.lxc:
      vars:
        # mysql vars
        mysql_root_password: needysroot
        mysql_databases:
        - name: needys
          encoding: utf8mb4
          collation: utf8mb4_unicode_ci
        mysql_users:
        - name: needys
          host: "%"
          password: needys
          priv: "needys.*:ALL"
        # rabbitmq vars
        rabbitmq_users:
          needys:
            password: needys
            tags: administrator
        # prometheus vars
        prometheus_web_listen_address: 0.0.0.0:9090
        prometheus_scrape_configs:
        - job_name: node
          file_sd_configs:
          - files:
            - "{{ prometheus_config_dir }}/file_sd/node.yml"
        - job_name: rabbitmq
          file_sd_configs:
          - files:
            - "{{ prometheus_config_dir }}/file_sd/rabbitmq.yml"
        - job_name: mysqld
          file_sd_configs:
          - files:
            - "{{ prometheus_config_dir }}/file_sd/mysqld.yml"
        prometheus_targets:
          node:
          - targets:
            - apis.needys.lxc:9100
            - services.needys.lxc:9100
            labels:
              env: production
          rabbitmq:
          - targets:
            - services.needys.lxc:9101
            labels:
              env: production
          mysqld:
          - targets:
            - services.needys.lxc:9102
            labels:
              env: production
        # prometheus-rabbitmq-exporter vars
        prometheus_rabbitmq_exporter_config_flags:
          rabbit_url: http://services.needys.lxc:15672
          rabbit_user: needys
          rabbit_password: needys
          publish_port: 9101
        # prometheus-mysqld-exporter vars
        mysqld_exporter_web_listen_address: 0.0.0.0:9102
        mysqld_exporter_dsn: needys:needys@(services.needys.lxc:3306)/
        # grafana vars
        grafana_url: http://services.needys.lxc:3000
        grafana_security:
          admin_user: needys
          admin_password: needys
        grafana_datasources:
        - name: prometheus
          type: prometheus
          access: proxy
          url: "http://{{ prometheus_web_listen_address }}"
          basicAuth: false

    # groups of group
    needys-application:
      children:
        needys-api-need:
        needys-output-producer:

    needys:
      children:
        needys-application:
        needys-services:
      vars:
        ansible_user: root
        lxc_infrastructure_interface_bridge: needys-lxc
